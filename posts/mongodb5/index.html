<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Indexing and Aggregation Pipeline" /><meta name="author" content="Babin" /><meta property="og:locale" content="en" /><meta name="description" content="Aggregation Framework The aggregation framework in its simplest form is just another way to query data in MongoDB. Everything we know how to do using the MongoDB query language (MQL) can also be done using the aggregation framework." /><meta property="og:description" content="Aggregation Framework The aggregation framework in its simplest form is just another way to query data in MongoDB. Everything we know how to do using the MongoDB query language (MQL) can also be done using the aggregation framework." /><link rel="canonical" href="https://babin411.github.io/posts/mongodb5/" /><meta property="og:url" content="https://babin411.github.io/posts/mongodb5/" /><meta property="og:site_name" content="Babin Joshi" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-06-15T00:00:00+05:45" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Indexing and Aggregation Pipeline" /><meta name="twitter:site" content="@BabinJoshi411" /><meta name="twitter:creator" content="@Babin" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Babin"},"dateModified":"2022-06-16T11:44:02+05:45","datePublished":"2022-06-15T00:00:00+05:45","description":"Aggregation Framework The aggregation framework in its simplest form is just another way to query data in MongoDB. Everything we know how to do using the MongoDB query language (MQL) can also be done using the aggregation framework.","headline":"Indexing and Aggregation Pipeline","mainEntityOfPage":{"@type":"WebPage","@id":"https://babin411.github.io/posts/mongodb5/"},"url":"https://babin411.github.io/posts/mongodb5/"}</script><title>5. Indexing and Aggregation Pipeline | Babin Joshi</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Babin Joshi"><meta name="application-name" content="Babin Joshi"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/dp.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Babin Joshi</a></div><div class="site-subtitle font-italic">Life is a cruel prank played on the living - Charles Boyle</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/babin411" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/BabinJoshi411" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['j.babin411','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>5. Indexing and Aggregation Pipeline</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>5. Indexing and Aggregation Pipeline</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/Babinjoshi411">Babin Joshi</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1655230500" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-06-15 </em> </span> <span> Updated <em class="timeago" data-ts="1655359142" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-06-16 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1300 words"> <em>7 min</em> read</span></div></div></div><div class="post-content"><h2 id="aggregation-framework"><span class="mr-2">Aggregation Framework</span><a href="#aggregation-framework" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>The aggregation framework in its simplest form is just another way to query data in MongoDB. Everything we know how to do using the MongoDB query language (MQL) can also be done using the aggregation framework.</p><p>Example: - Let’s find all documents that have wi-fi as one of the amenities only including the price and address in the resulting cursor. With MQL, we will use the following command:-</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>    db.listingsAndReviews.find(
        {
            'amenities': 'Wifi'
        },
        {
            'price': 1,
            'address': 1,
            '_id': 0
        }
    ).pretty()
</pre></table></code></div></div><p>With the aggregation framework, we use the following command:-</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>    db.listingsAndReviews.aggregate(
        [
            { "$match": 
                { "amenities": "Wifi" } 
            },
            { "$project": { "price": 1,
                            "address": 1,
                            "_id": 0 }
            }
        ]
    ).pretty()

</pre></table></code></div></div><p>To use the aggregation framework, we use the <code class="language-plaintext highlighter-rouge">aggregate</code> instead of <code class="language-plaintext highlighter-rouge">find</code>. The reason for that is because sometimes we might want to aggregate, as in group or modify our data in some way, instead of always just filtering for the right documents. This means that you can perform operations other than finding and projecting data. But you can also claculate using aggregation. The aggregatoin framework works as a pipeline, where the order of actions in the pipeline matters. And each action is executed in the order in which we list it. Meaning that we give our data to the pipeline on our end, then we describe how this pipeline is going to treat our data using aggregation stages. And then the transformed data emerges at the end of the pipeline.</p><h2 id="the-group-stage"><span class="mr-2">The “$group” stage</span><a href="#the-group-stage" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>The <code class="language-plaintext highlighter-rouge">$group</code> stage is one of the many stages that differentiates the aggregation framework from MQL. With MQL, we can filter and update data. With the aggregation framework, we can compute and reshape data. The <code class="language-plaintext highlighter-rouge">$group</code> is an operator that takes the incoming stream of data and siphons it into multiple distinct reservoiors.</p><p>Syntax:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>    {
        '$group': {
            '_id': &lt;expression&gt;, //Group By Expression
            &lt;field1&gt;: {
                &lt;acumulator1&gt;: &lt;expression1&gt;
            },
            ...,
            }
        }
    }
</pre></table></code></div></div><p>Example-1:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre>    db.listingsAndReviews.aggregate(
        [
            {
                '$project': {
                    'address': 1,
                    '_id': 0
                }
            },
            {
                '$group': {
                    '_id': '$address.country'
                }
            }
        ]
    )
</pre></table></code></div></div><blockquote class="prompt-info"><div><p>The above query projects only the address field value for each document, then group all documents into one document per address.country value.</p></div></blockquote><p>Example-2:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre>    db.listingsAndReviews.aggregate(
        [
            {
                '$project': {
                    'address': 1,
                    '_id': 0
                }
            },
            {
                '$group': {
                    '_id': '$address.country',
                }
            }
        ]
    )
</pre></table></code></div></div><blockquote class="prompt-info"><div><p>The above query projects only the address field value for each document, then group all documents into one document per address.country value, and count one for each document in each group.</p></div></blockquote><h2 id="sort-and-limit"><span class="mr-2">sort() and limit()</span><a href="#sort-and-limit" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Sometimes, when we’re creating a collection, we are not interested in all the results, but are looking for the top 3 or top 10 results.</p><p>Suppose we want to find the least popoulated zip code in the <code class="language-plaintext highlighter-rouge">zips</code> collection. Then we willl use the following query.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>    db.zips.find().sort(
        {
            'pop': 1
        }
    ).limit(1).pretty()
</pre></table></code></div></div><blockquote class="promp-info"><p>The above query gets all the documents, sorts them by their population in <code class="language-plaintext highlighter-rouge">ascending or increasing</code> order, and only returns the first document in the cursor, a.k.a the one with the smallest population value.</p></blockquote><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>    db.zips.find().sort(
        {
            'pop': -1
        }
    ).limit(10).pretty()
</pre></table></code></div></div><blockquote class="promp-info"><p>The above query gets all the documents, sorts them by their population in <code class="language-plaintext highlighter-rouge">descending or decreasing</code> order, and only returns the first 10 document in the cursor, a.k.a the one with the largest population value.</p></blockquote><p>The <code class="language-plaintext highlighter-rouge">sort()</code> and <code class="language-plaintext highlighter-rouge">limit()</code> are cursore methods. A cursor method is not applied to the data that is stored in the database. It is instead applied to the result set that lives in the cursor. After the curosr is populated with the filter data that’s the result of the Find command, we can then apply the sort() method which will sort the data based on the criteria that we provided.</p><p>We can sort the data by one or more fields in increasing or decreasing direction. For example: -</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>    db.zips.find().sort(
        {
            'pop': 1,
            'city': -1
        }
    )
</pre></table></code></div></div><blockquote class="prompt-info"><div><p>The above query gets all the documenets, sorts them in the increasing order by population and decreasing order by the city name.</p></div></blockquote><h2 id="indexes"><span class="mr-2">Indexes</span><a href="#indexes" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Indexes are one of the most impactful way to improving query performance. An index in a databse is, by its function, similar to an index in a book, where you have an alphabetical list of names and subjects with references to the places where they occur. Index in database is a special data structure that stores a small portion of the collection’s data set in an easy to traverse form. In simple terms, an index is a data structure that optimizes queries.</p><p>Given:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>    db.trips.find({'birth year': 1989})

    db.trips.find({'start station id': 476}).sort('birth year': 1)
</pre></table></code></div></div><p>The first query filters the data by the value of the birth year and the second sorts by the value of that field. Both could benefit from that index.</p><ul><li>Creating an Index:<ul><li>Single field index<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>      db.trips.createIndex(
          {
              'birth year': 1
          }
      )
</pre></table></code></div></div><blockquote class="prompt-info"><div><p>The above query creates an index on the birth year field in increasing order.</p></div></blockquote><li>Compund index: an index on multiple fields.<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>      db.trips.createIndex(
          {
              'start station id': 1,
              'birth year': 1
          }
      )
</pre></table></code></div></div></ul></ul><h1 id="data-modeling">Data Modeling</h1><p>MongoDB doesn’t enforce how data is organized by default. So how can we decide what structure to use to store our data? Where should we create subdocuments? And where should we use arrays of values? At which point should data get its own collection?</p><p>Making these decision about the shape and structure of our data is called <code class="language-plaintext highlighter-rouge">Data Modeling</code>. More specifically, Data Modeling is a way to orgranize fields in a document to support our applicaiton performacen and querying capabilities.</p><p>The most important rule of thumb in data modeling with MongoDB is that data is stored in the way that it is used. This notion determines the decision that we make about the shape of our document and the number of our collections.</p><blockquote class="prompt-tip"><div><p><strong>Note</strong>: Data that is used/acccessed together should be stored together. And as our application evolves, our data model should also evolve.</p></div></blockquote><h2 id="upsert"><span class="mr-2">Upsert</span><a href="#upsert" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Everything in MOSQL that can be used to <strong>locate</strong> a docuent in a collection can also be used to <strong>modify</strong> the document.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>    db.collection.updateOne(
        {
            &lt;query to locate&gt;
        },
        {
            update
        }
    )
</pre></table></code></div></div><p>The first part of the update operation is the query to locate the document in question. One of the awesome features of MQL is the <code class="language-plaintext highlighter-rouge">upsert</code> option within the update documents.</p><p>Upsert is a hybrid of update and insert, and it should only be used when it is needed.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>    db.collection.updateOne(
        {
            &lt;query&gt;
        },
        {
            &lt;update&gt;
        },
        {
            'upsert': true
        }
    )
</pre></table></code></div></div><p>By default <code class="language-plaintext highlighter-rouge">upsert</code> is set to false, but if it is set to ture, we can expect it to do either an update or an insert. THe update will happen if there are documents that match the filter criteria of the update operation. The insert will happen if there are no documents that match the filter criteria.</p><p>Example:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre>    db.iot.updateOne(
        {
            'sensor': r.sensor,
            'date': r.date,
            'valcount': {
                '$lt': 48
            }
        },
        {
            '$push': {
                'readings': {
                    'v': r.value,
                    't': r.time
                }
            },
            '$inc': {
                'valuecount': 1,
                'total': r.value
            }
        },
        {
            'upsert': true
        }
    )

</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/mongodb/'>MongoDB</a>, <a href='/categories/mongodb-basics/'>MongoDB Basics</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/mongodb/" class="post-tag no-text-decoration" >mongodb</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=5. Indexing and Aggregation Pipeline - Babin Joshi&amp;url=https://babin411.github.io/posts/mongodb5/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=5. Indexing and Aggregation Pipeline - Babin Joshi&amp;u=https://babin411.github.io/posts/mongodb5/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://babin411.github.io/posts/mongodb5/&amp;text=5. Indexing and Aggregation Pipeline - Babin Joshi" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/wildcards/">Wild Cards Tutorial</a><li><a href="/posts/Linux-Basic-Commands/">Basic Linux Commands</a><li><a href="/posts/3sql4/">Window Functions</a><li><a href="/posts/pandas1/">Introduction to Pandas</a><li><a href="/posts/mongodb-dm4/">4. Patterns 2</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/sql/">sql</a> <a class="post-tag" href="/tags/t-sql/">t-sql</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/mongodb/">mongodb</a> <a class="post-tag" href="/tags/curl/">curl</a> <a class="post-tag" href="/tags/wget/">wget</a> <a class="post-tag" href="/tags/avg/">avg</a> <a class="post-tag" href="/tags/count/">count</a> <a class="post-tag" href="/tags/max/">max</a> <a class="post-tag" href="/tags/min/">min</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/mongodb1/"><div class="card-body"> <em class="timeago small" data-ts="1655144100" > 2022-06-14 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>1. What is MongoDB?</h3><div class="text-muted small"><p> What is a MongoDB Database? A database, meaning a structured way to store and access data. More specifically, it is a NoSQL database. NoSQL databases mean that it doesn’t use the traditional appro...</p></div></div></a></div><div class="card"> <a href="/posts/mongodb2/"><div class="card-body"> <em class="timeago small" data-ts="1655144100" > 2022-06-14 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>2. Importing, Exporting, and Querying Data</h3><div class="text-muted small"><p> How Does MongoDB Store Data? MongoDB uses documents to store data. When we view or update documents in the MongoDB shell, you’re working in JSON which stands for ‘JavaScript Standard Object Notati...</p></div></div></a></div><div class="card"> <a href="/posts/mongodb3/"><div class="card-body"> <em class="timeago small" data-ts="1655144100" > 2022-06-14 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>3. Creating and Manipulating Documents</h3><div class="text-muted small"><p> Inserting New Documents Every MongoDB document must have unique _id value. ANd every _id field in a collection must have a unique value from the rest of the documents in the collection. Likewise, ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/mongodb4/" class="btn btn-outline-primary" prompt="Older"><p>4. Advanced CRUD Operations</p></a> <a href="/posts/mongodb-dm1/" class="btn btn-outline-primary" prompt="Newer"><p>1. Introduction to Data Modeling</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/Babinjoshi411">Babin Joshi</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/sql/">sql</a> <a class="post-tag" href="/tags/t-sql/">t-sql</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/mongodb/">mongodb</a> <a class="post-tag" href="/tags/curl/">curl</a> <a class="post-tag" href="/tags/wget/">wget</a> <a class="post-tag" href="/tags/avg/">avg</a> <a class="post-tag" href="/tags/count/">count</a> <a class="post-tag" href="/tags/max/">max</a> <a class="post-tag" href="/tags/min/">min</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
